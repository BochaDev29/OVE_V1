// Tipos centralizados para el Taller CAD
import { CircuitInventoryItemForCAD } from '../lib/electrical-rules';
import type { Floor } from './floors';

export type SymbolType =
    // SÃ­mbolos de Planta
    | 'light' | 'wall_light' | 'outlet' | 'double_outlet'
    | 'switch' | 'switch_2e' | 'switch_3e' | 'switch_3way' | 'bell_button'
    | 'motion_sensor' | 'photo_cell' | 'riser'
    | 'cp' | 'ac' | 'fan' | 'motor_1p' | 'motor_3p'
    | 'board' | 'tpu' | 'ground'
    // SÃ­mbolos Unifilares â€” AlimentaciÃ³n
    | 'meter'
    // SÃ­mbolos Unifilares â€” LÃ­neas y Circuitos
    | 'lp_220' | 'lp_380' | 'cs_220' | 'cs_380' | 'ct_220' | 'ct_380'
    // SÃ­mbolos Unifilares â€” Borneras
    | 'dist_block' | 'dist_block_2' | 'dist_block_3' | 'dist_block_4' | 'dist_block_5'
    | 'dist_block_6' | 'dist_block_7' | 'dist_block_8' | 'dist_block_9' | 'dist_block_10'
    // SÃ­mbolos Unifilares â€” Protecciones
    | 'pia_1p' | 'pia_3p'
    | 'diff_switch' | 'id_3p'
    // SÃ­mbolos Unifilares â€” Motores y arranque
    | 'gm_thermo' | 'gm_mag' | 'contactor' | 'thermal_relay'
    // SÃ­mbolos Unifilares â€” Legacy (compatibilidad)
    | 'load_arrow'
    // Especiales
    | 'text' | 'table' | 'rect' | 'circle' | 'triangle' | 'line' | 'arrow';

export type TradeCategory = 'electrical' | 'gas' | 'plumbing';

// ðŸ†• LayerId ahora soporta IDs dinÃ¡micos de circuitos ademÃ¡s de las capas fijas
export type LayerId = string; // Puede ser 'layer-0' (arquitectura), 'layer-N' (circuito), etc.

export interface SymbolDefinition {
    id: SymbolType;
    name: string;
    category: TradeCategory;
    svgPath: string;
    strokeColor: string;
    fillColor?: string;
    // Embedded text elements that are part of the symbol's graphic
    // (e.g. 'kWh' inside meter, 'êž®>' inside guarda motor)
    textElements?: Array<{
        text: string;
        x: number;
        y: number;
        fontSize: number;
        width?: number; // Para centrado automÃ¡tico
        align?: 'left' | 'center' | 'right';
        fill?: string;
        fontStyle?: string; // 'bold' | 'italic' etc.
    }>;
    metadata: {
        description: string;
        normative?: string; // Ej: "AEA 90364-7-771"
        defaultLabel?: string;
    };
}

export interface SymbolItem {
    id: string;
    type: SymbolType;
    x: number;
    y: number;
    rotation: number;
    scaleX?: number;
    scaleY?: number;
    label?: string;
    color?: string;
    fontSize?: number;
    layer?: LayerId;
    points?: number[]; // ðŸ†• Para geometrÃ­as basadas en puntos (lÃ­nea, flecha)
    nature?: 'relevado' | 'proyectado'; // ðŸ†• NATURALEZA

    // ðŸ†• Circuit data (heredado de la capa)
    circuitId?: string; // ID del circuito (ej: "TP-IUG-1")

    // ðŸ†• Auto-generaciÃ³n
    autoGenerated?: boolean; // Flag para elementos generados automÃ¡ticamente

    // ðŸ†• Propiedades de GeometrÃ­a
    fill?: string;
    strokeDash?: number[];
    isSolid?: boolean;
    lineType?: 'solid' | 'dashed' | 'dotted' | 'symmetry';
}

export interface Wall {
    id: string;
    points: number[];
    layer?: LayerId;
    nature?: 'relevado' | 'proyectado'; // ðŸ†• NATURALEZA

    // ðŸ†• Circuit data (para elementos arquitectÃ³nicos no aplica)
    circuitId?: string;
}

export interface Pipe {
    id: string;
    points: number[];
    color: string;
    type: 'straight' | 'curved';
    controlPoint?: { x: number; y: number }; // ðŸ†• Punto de control para curvas (novedad)
    layer?: LayerId;
    nature?: 'relevado' | 'proyectado'; // ðŸ†• NATURALEZA

    // ðŸ†• Circuit data (heredado de la capa)
    circuitId?: string; // ID del circuito que representa este caÃ±o
}

export interface AuxLine {
    id: string;
    points: number[];
    layer?: LayerId;
}

export interface Layer {
    id: LayerId;
    name: string;
    visible: boolean;
    locked: boolean;
    opacity: number;
    color: string;

    // ðŸ†• Circuit-based layer data
    circuitId?: string | null; // null para capa arquitectura, string para capas de circuito
    circuit?: CircuitInventoryItemForCAD; // Datos completos del circuito (cable, protecciÃ³n, conduit)
}

export interface ProjectData {
    projectName: string;
    address: string;
    installer: string;
    category: string;
    date: string;
}

export interface DrawingData {
    // Formato nuevo (unificado) - ambos modos comparten el mismo canvas
    floors?: Floor[];
    pixelsPerMeter?: number;

    // Formato antiguo (dual-mode) - para compatibilidad con proyectos existentes
    floorPlan?: {
        symbols?: SymbolItem[];
        walls?: Wall[];
        pipes?: Pipe[];
        auxLines?: AuxLine[];
        pixelsPerMeter?: number;
        floors?: Floor[];
    };
    singleLine?: {
        symbols?: SymbolItem[];
        walls?: Wall[];
        pipes?: Pipe[];
        auxLines?: AuxLine[];
        pixelsPerMeter?: number;
        floors?: Floor[];
    };
    backgroundBase64?: string | null;
    backgroundProps?: {
        x: number;
        y: number;
        scaleX: number;
        scaleY: number;
        rotation: number;
    };
}

export interface MaterialReport {
    counts: Record<string, number>;
    totalPipeMeters: number;
    totalCableMeters: number;
}

export interface TradeCatalog {
    id: string;
    name: string;
    version: string;
    symbols: SymbolDefinition[];
    calculations: {
        materials: (symbols: SymbolItem[], pipes: Pipe[], pixelsPerMeter: number) => MaterialReport;
        loads?: (symbols: SymbolItem[]) => any;
    };
}
